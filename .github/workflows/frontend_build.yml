name: downloader_frontend_ci-cd

on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - '**/README.md'
    if: github.repository == 'redyk654/downloader_frontend'
  pull_request:
    branches:
      - main
      - master
    if: github.repository == 'redyk654/downloader_frontend'

jobs:
  build-and-test:
    if: github.repository == 'redyk654/downloader_frontend'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Run unit tests
        run: npx jest --config jest.config.cjs --runInBand

      - name: Build project
        run: npm run build

  deploy:
    if: github.repository == 'redyk654/downloader_frontend' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    needs: build-and-test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Build project
        run: npm run build

      - name: Prepare deployment directory on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # CrÃ©er le dossier temporaire
            mkdir -p /tmp/deploy-frontend
            chmod 755 /tmp/deploy-frontend
            echo "âœ… Dossier temporaire prÃ©parÃ©"

      - name: Upload build files to temporary directory
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "dist/*"
          target: "/tmp/deploy-frontend/"
          strip_components: 0

      - name: Finalize deployment on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            TARGET_DIR="/var/www/vidown"
            
            # CrÃ©er le dossier de production s'il n'existe pas
            sudo mkdir -p "$TARGET_DIR"
            
            # Sauvegarder l'ancienne version
            if [ -d "$TARGET_DIR" ]; then
              backup_dir="/var/www/backup-vidown-$(date +%Y%m%d%H%M%S)"
              sudo mkdir -p "$backup_dir"
              sudo cp -r "$TARGET_DIR"/* "$backup_dir/" 2>/dev/null || true
              echo "ğŸ“¦ Ancienne version sauvegardÃ©e dans: $backup_dir"
            fi
            
            # Supprimer l'ancien contenu
            sudo rm -rf "$TARGET_DIR"/*
            
            # DÃ©placer le contenu du dossier dist/ vers la racine
            if [ -d "/tmp/deploy-frontend/dist" ]; then
              echo "ğŸ“ Structure dÃ©tectÃ©e: dÃ©placement depuis dist/"
              sudo mv /tmp/deploy-frontend/dist/* "$TARGET_DIR"/
            else
              echo "ğŸ“ Structure plate: dÃ©placement direct"
              sudo mv /tmp/deploy-frontend/* "$TARGET_DIR"/
            fi
            
            # Corriger les permissions
            sudo chown -R www-data:www-data "$TARGET_DIR"
            sudo chmod -R 755 "$TARGET_DIR"
            
            # Nettoyer le dossier temporaire
            rm -rf /tmp/deploy-frontend
            
            # RedÃ©marrer Nginx
            sudo systemctl restart nginx
            
            # VÃ©rifier le dÃ©ploiement
            if [ -f "$TARGET_DIR/index.html" ]; then
              echo "âœ… DÃ©ploiement terminÃ© avec succÃ¨s !"
              echo "ğŸ“ Dossier: $TARGET_DIR"
              echo "ğŸ“Š Contenu:"
              ls -la "$TARGET_DIR"/
              echo "ğŸŒ Application dÃ©ployÃ©e avec succÃ¨s"
            else
              echo "âŒ Erreur: index.html non trouvÃ© dans $TARGET_DIR"
              echo "ğŸ“Š Contenu du dossier:"
              ls -la "$TARGET_DIR"/
              echo "ğŸ“ Contenu de /tmp/deploy-frontend:"
              ls -la /tmp/deploy-frontend/
              exit 1
            fi

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            TARGET_DIR="/var/www/vidown"
            echo "ğŸ” VÃ©rification finale..."
            echo "ğŸ“Š Contenu de $TARGET_DIR:"
            ls -la "$TARGET_DIR"/
            echo "ğŸŒ Test HTTP:"
            curl -s -o /dev/null -w "HTTP Code: %{http_code}\n" http://localhost || true
            echo "âœ… VÃ©rification terminÃ©e"