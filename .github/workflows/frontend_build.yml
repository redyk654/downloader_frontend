name: downloader_frontend_ci-cd

on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - '**/README.md'
    if: github.repository == 'redyk654/downloader_frontend'
  pull_request:
    branches:
      - main
      - master
    if: github.repository == 'redyk654/downloader_frontend'

jobs:
  build-and-test:
    if: github.repository == 'redyk654/downloader_frontend'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Run unit tests
        run: npx jest --config jest.config.cjs --runInBand

      - name: Build project
        run: npm run build

  deploy:
    if: github.repository == 'redyk654/downloader_frontend' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    needs: build-and-test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Build project
        run: npm run build

      - name: Prepare deployment directory on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # Cr√©er le dossier temporaire
            mkdir -p /tmp/deploy-frontend
            chmod 755 /tmp/deploy-frontend
            echo "‚úÖ Dossier temporaire pr√©par√©"

      - name: Upload build files to temporary directory
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "dist/*"
          target: "/tmp/deploy-frontend/"
          strip_components: 0

      - name: Finalize deployment on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # Utiliser le chemin correct depuis votre configuration Nginx
            TARGET_DIR="/var/www/vidown"
            
            # Cr√©er le dossier de production s'il n'existe pas
            sudo mkdir -p "$TARGET_DIR"
            
            # Sauvegarder l'ancienne version
            if [ -d "$TARGET_DIR" ]; then
              backup_dir="/var/www/backup-vidown-$(date +%Y%m%d%H%M%S)"
              sudo mkdir -p "$backup_dir"
              sudo cp -r "$TARGET_DIR"/* "$backup_dir/" 2>/dev/null || true
              echo "üì¶ Ancienne version sauvegard√©e dans: $backup_dir"
            fi
            
            # Supprimer l'ancien contenu
            sudo rm -rf "$TARGET_DIR"/*
            
            # D√©placer les nouveaux fichiers
            sudo mv /tmp/deploy-frontend/* "$TARGET_DIR"/
            
            # Corriger les permissions (www-data pour Nginx)
            sudo chown -R www-data:www-data "$TARGET_DIR"
            sudo chmod -R 755 "$TARGET_DIR"
            
            # Nettoyer le dossier temporaire
            rm -rf /tmp/deploy-frontend
            
            # Red√©marrer Nginx
            sudo systemctl restart nginx
            
            # V√©rifier le d√©ploiement
            if [ -f "$TARGET_DIR/index.html" ]; then
              echo "‚úÖ D√©ploiement termin√© avec succ√®s !"
              echo "üìÅ Dossier: $TARGET_DIR"
              echo "üåê Application d√©ploy√©e avec succ√®s"
            else
              echo "‚ùå Erreur: index.html non trouv√© dans $TARGET_DIR"
              echo "Contenu du dossier:"
              ls -la "$TARGET_DIR"/
              exit 1
            fi

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            TARGET_DIR="/var/www/vidown"
            echo "üîç V√©rification du d√©ploiement..."
            echo "üìÅ Contenu de $TARGET_DIR :"
            ls -la "$TARGET_DIR"/
            
            echo "üìä Taille des fichiers :"
            du -sh "$TARGET_DIR"/*
            
            echo "üåê Test de l'application :"
            curl -s -o /dev/null -w "HTTP Code: %{http_code}\n" http://localhost || true
            
            echo "‚úÖ V√©rification termin√©e"